# Lab 08: Create a multi-tier solution by using Azure services

## Lab Scenario

In this proof of concept, you will create a containerized application to host a web app on Azure, as the source of information for the API. You will then build an API proxy using the Azure API Management capabilities to expose and test your APIs. Developers can query the APIs to test the service and validate its applicability.

## Lab objectives

In this lab, you will perform:

+ Exercise 1: Create an Azure App Service resource by using a Docker container image
+ Exercise 2: Build an API proxy tier by using Azure API Management
    
## Estimated timing: 60 minutes

## Architecture diagram

![Architecture diagram depicting the creation of a multi-tier application by using Azure services.](./media/Lab008-Diagram.png)

### Task 00: Lab setup and pre-requisites

Before starting this lab, you must complete **Prerequisites** of this lab.

To install **C#** extension for this lab, follow the below steps in Visual Studio code:

1. Start Visual Studio Code.

     ![Visual Studio Code Icon](./media/vscode.jpg)

2. Select the **Extensions (1)** blade from the left panel. Search with **C# (2)** and select **Install (3)** to install the extension.

    ![](./media/lab02-az-204-image1.png)

4. After installing C# extensions, close the Visual Studio code.

## Exercise 1: Create an Azure App Service resource by using a Docker container image

In this exercise, you create a new Azure web app by using a container image sourced from Docker Hub.

### Task 1: Open the Azure portal

1. If you are not logged in already, click on the **Azure portal** shortcut that is available on the desktop and log in with Azure credentials.

1. If not signed in, then on the **Sign into Microsoft Azure** tab you will see the login screen, in that enter the following **Email/Username** and click on **Next**. 

   * Email/Username: <inject key="AzureAdUserEmail"></inject>
   
     ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/raw/main/media/M2-Ex1-portalsignin-1.png?raw=true)
    
1. Now enter the following **Password** and click on **Sign in**.

   * Password: <inject key="AzureAdUserPassword"></inject>

     ![](./media/M2-Ex1-portalsignin-(2).png)
    
1. If you see the pop-up **Stay Signed in?**, click No.

    ![](./media/staysignedinNO1.png)

1. On the **Welcome to Microsoft Azure** page, click on **Cancel**.

    ![](./media/15125(1).png)

### Task 2: Create a web app by using Azure App Service resource by using an httpbin container image

1. In the Azure portal, use the **Search resources, services, and docs** text box to search for **App Services** and, in the list of results, select **App Services**.

1. On the **App Services** blade, select **+ Create**.

1. On the **Create Web App** blade, on the **Basics** tab, perform the following actions, and then select the **Container** tab:

    
    | Setting                         | Action                                                       |
    | ------------------------------- | ------------------------------------------------------------ |
    | **Subscription** drop-down list | Retain the default value                              |
    | **Resource group** section      | Select **ApiService-<inject key="DeploymentID" enableCopy="false"/>**. |
    | **Name** text box               | Enter **httpapi<inject key="DeploymentID" enableCopy="false"/>**|
    | **Secure unique default hostname** | **Disabled** |
    | **Publish** section             | Select **Container**                              |
    | **Operating System** section    | Select **Linux**                                       |
    | **Region** drop-down list       | West US |
    | **Linux Plan** section          | Select **Create new**, enter  the value **ApiPlan** in the **Name** text  box, and then select **OK**. |
    | **Pricing Plan** section        | Select **Explore Pricing plan**, on the **Select App service Pricing Plan** blade, select **Standard S1** under Production then click on **Select**. 
    
    ![](./media/15125(8).png) 

1. On the **Container** tab, perform the following actions, and then select **Review + create**:

    | Setting | Action |
    | -- | -- |
    | **Image Source** | Select **Other container registries** |
    | **Access Type**  | Select **Public** |
    | **Registry server URL** | `https://index.docker.io` |
    | **Image and tag** text box | Enter **kennethreitz/httpbin:latest** |

1. On the **Review + create** tab, review the options that you selected during the previous steps.

1. Select **Create** to create the web app by using your specified configuration.

    > **Note**: Wait for the creation task to complete before you proceed with this lab.

### Task 3: Test the httpbin web application

1. In the Azure portal, use the **Search resources, services, and docs** text box to search for **App Services** and, in the list of results, select **App Services**.

1. On the **App Services** blade, select the newly created web app.

1. On the blade displaying the newly created app properties, select **Browse**.

    >**Note**: There may be a 2-3 minute delay before the web page renders. If a 504 Gateway timeout occurs, Refresh your browser.

1. Within the web application, perform the following actions:

    a. Select **Response formats**.

    b. Select **GET /html**.

    c. Select **Try it out**.

    The following screenshot displays the **Try it out** section of the web application.

    ![](./media/AZ-204-8.png)

    d. Select **Execute**.

    e. Review the value of the **Response body** and **Response headers** text boxes.

    f. Review the value of the **Request URL** text box.
  
6. Within the web application, perform the following actions:

    a. Select **Dynamic data**.

    b. Select **GET /bytes/{n}**.

    c. Select **Try it out**.

    d. In the **n** text box, enter **25**.

    e. Select **Execute**.

    f. Review the value of the **Response body** and **Response headers** text boxes.

    g. Select **Download file**, and after the file downloads, open it in Notepad, review its content, and then close it.

    > **Note**: The file contains a sequence of randomly generated bytes.

    The following screenshot displays the dynamic data section of the web application.
  
    ![httpbin.org API page GET /bytes/{n} dynamic data section](./media/l08_response_to_dynamic_data.png)

1. Within the web application, perform the following actions:

    a. Select **Status codes**.

    b. Select **GET /status/{codes}**.

    c. Select **Try it out**.

    d. In the **codes** text box, enter **404**.

    e. Select **Execute**.

     ![](./media/Lab-08_Ex1_Task3_2.png)

    f. Review the **Server response** and note that it includes an **Error: NOT FOUND** entry.
     
1. Close the browser window that displays the web application.

1. Switch back to the browser window that displays the **httpapi<inject key="DeploymentID" enableCopy="false"/>** web app.

1. On the **App Service Overview** blade, in the **Essentials**, record the value of the **Default domain** link. You'll use this value later in the lab to send requests to the corresponding API.

    > **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:
   - Hit the Validate button for the corresponding task.
   - If you receive a success message, you can proceed to the next task.
   - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
   - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help you out.
 
   <validation step="2ddfe94d-20e1-445c-b00d-85a5af8c9653" />

### Review

In this exercise, you created a new Azure web app by using a container image sourced from Docker Hub.

## Exercise 2: Build an API proxy tier by using Azure API Management

In this exercise, you built a proxy tier between your App Service resource and any developers who wish to make queries against its API.

### Task 1: Create an API Management resource

1. In the Azure portal, use the **Search resources, services, and docs** text box to search for **API Management services** and, in the list of results, select **API Management services**.

1. On the **API Management services** blade, select **+ Create**.

1. On the **Create API Management service** blade, perform the following actions, and then select **Review + create**:

    
    | Setting                           | Action                                                       |
    | --------------------------------- | ------------------------------------------------------------ |
    | **Subscription** drop-down list    | Retain the default value                                    |
    | **Resource group** section        | Select the **ApiService-<inject key="DeploymentID" enableCopy="false"/>** group|
    | **Region** list                   | Select the same region you chose in the previous exercise. |
    | **Resource name** text box        | Enter **proapi<inject key="DeploymentID" enableCopy="false"/>** |
    | **Organization name** text box    | Enter **Contoso**                                           |
    | **Administrator email** text  box | Enter `admin@contoso.com`                                    |
    | **Pricing tier** drop-down  list   | **Consumption (99.95% SLA)**                                |

    The following screenshot displays the configured settings of **Create API Management** blade of the web application.
    
    ![Create an API Management blade](./media/AZ-204-create-api.png)

1. On the **Review + create** tab, review the option that you specified in the previous step, and then select **Create**.

    > **Note**: Wait for the creation task to complete before you continue with this lab.

1. On the **Deployment Overview** blade, select **Go to resource**.

    > **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:
   - Hit the Validate button for the corresponding task.
   - If you receive a success message, you can proceed to the next task.
   - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
   - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help you out.
 
   <validation step="d3af110c-8f31-4a2b-8ee9-dcc6fb2d27cc" />

### Task 2: Define a new API

1. On the **API Management Service** blade, in the **APIs** section, select **APIs**.

1. In the **Define a new API** section, select **HTTP**.

1. In the **Create an HTTP API** window, perform the following actions and select **Create**:
    
    | Setting | Action |
    | -- | -- |
    | **Display name** text box | Enter **HTTPBin API** |
    | **Name** text box | Enter **httpbin-api** |
    | **Web service URL** text box | Enter the URL for the web app that you copied earlier in this lab. **Note**: Make sure that the URL starts with the https:// prefix |
    | **API URL suffix** text box | Leave it empty |
 
    The following screenshot displays the configured settings of **Create a blank API** window of the web application.

    ![Create a blank API pane](./media/l08_create_blank_api.png)

    > **Note**: Wait for the new API to finish being created.

1. On the **Design** tab, select **+ Add operation**.

1. In the **Add operation** section, perform the following actions, and then select **Save**:

    | Setting | Action |
    | -- | -- |
    | **Display name** text box | Enter **Echo Headers** |
    | **Name** text box | Verify that its value is set to **echo-headers** |
    | **URL** list | Select **GET** |
    | **URL** text box | Enter **/** |

    The following screenshot displays the configured settings of the **Add operation** section.
    
    ![The properties of the Add Echo Headers operation](./media/l08_add_echo_headers_operation.png)
    
1. Back on the **Design** tab, in the list of operations, select **Echo Headers**.

1. In the **Design** section, on the **Inbound processing** tile select **+ Add policy**.

1. In the **Add inbound policy** section, select the **Set headers** tile.

1. In the **Set Headers** section, perform the following actions, and then select **Save**:
    
    | Setting | Action |
    | -- | -- |
    | **Name** text box    | Enter **source** |
    | **Value** text box | Select the list, select **Add Value**, and then enter **azure-api-mgmt** |
    | **Action** list | Select **append** |

    The following screenshot displays the configured settings of the **Design** section.

    ![The Echo Headers design pane](./media/l08_get_echo_headers_design.png)

1. Back on the **Design** tab, in the list of operations, select **Echo Headers**.

1. In the **Design** section for **Echo Headers**, on the **Backend** tile, select the pencil icon.

1. In the **Backend** section, perform the following actions, and then select **Save**:

    | Setting                           | Action                                                       |
    | --------------------------------- | ------------------------------------------------------------ |
    | **Service URL** section    | Select the **Override** check box |
    | **Service URL** text box | Append the value **/headers** to its current value. **Note**: For example, if the current value is **https://httpapi[DeploymentID].azurewebsites.net**, the new value will be **https://httpapi[DeploymentID].azurewebsites.net/headers** |

     ![](./media/az204-8-2.png)  

1. Back on the **Design** tab, in the list of operations, select **Echo Headers**, and then select the **Test** tab.

1. In the **Echo Headers** section, select **Send**.

    The following screenshot displays the configured settings of the **Echo Headers** section.

    ![The Test Echo Headers tab](./media/l08_test_echo_headers.png)
    
1. Review the results of the API request.

    > **Note**: Verify that there are many headers sent as part of your request that are echoed in the response. They should include the new **Source** header that you created as part of this task.
     
    The following screenshot displays the response to the **Echo Headers** request.

    ![](./media/15125(9).png)
     
1. Select the **Design** tab to return to the list of operations.

### Task 3: Manipulate an API response

1. On the **Design** tab, select **+ Add operation**.

1. In the **Add operation** section, perform the following actions, and then select **Save**:

    | Setting | Action |
    | -- | -- |
    | **Display name** text box | Enter **Get Legacy Data** |
    | **Name** text box | Verify that its value is set to **get-legacy-data** |
    | **URL** list | Verify that its value is set to **GET** |
    | **URL** text box | Enter **/xml** |

1. Back on the **Design** tab, in the list of operations, select **Get Legacy Data**.

1. Select the **Test** tab, and then select **Send**.

1. Review the results of the API request.

    > **Note**: At this point, the results should be in XML format.

    The following screenshot displays the results of the API request.
    
    ![](./media/15125(10).png)

1. Select the **Design** tab, and then select **Get Legacy Data**.

1. On the **Design** pane, in the **Outbound processing** section, select **+ Add policy**.
    
    The following screenshot displays the **Outbound processing** section.
    
    ![An outbound processing section of the get legacy data operation](./media/l08_get_legacy_data_outbound_processing.png)
    
1. In the **Add outbound policy** section, select the **Other policies** tile.

1. In the policy code editor, find the following block of XML content:

    ```
    <outbound>
        <base />
    </outbound>
    ```

1. Replace that block of XML with the following XML:

    ```
    <outbound>
        <base />
        <xml-to-json kind="direct" apply="always" consider-accept-header="false" />
    </outbound>
    ```

    ![](./media/15125(11).png)  

1. In the policy code editor, select **Save**.

1. Back on the **Design** tab, in the list of operations, select **Get Legacy Data**, and then select **Test**.

1. In the **Get Legacy Data** section, select **Send**.

1. Review the results of the API request.

    > **Note**: The new results are in JavaScript Object Notation (JSON) format.

    ![](./media/15125(12).png)

1. Within the **HTTP response** section, perform the following actions:

    - Select **Trace**.

    - If prompted, select **Enable tracing for one hour**.

    - Select the **Trace** tab, review the content in the **Backend** and **Outbound** text boxes, and note that they include details of the corresponding API operations with their timing information.
    
    > **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:
   - Hit the Validate button for the corresponding task.
   - If you receive a success message, you can proceed to the next task.
   - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
   - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help you out.
 
   <validation step="03e97225-e9be-45cd-aa56-12640e71e726" />

### Task 4: Manipulate an API request

1. On the **Design** tab, select **+ Add operation**.

1. In the **Add operation** section, perform the following actions, and then select **Save**:

    | Setting  | Action |
    | -- | -- |
    | **Display name** text box | Enter **Modify Status Code** |
    | **Name** text box | Verify that its value is set to **modify-status-code** |
    | **URL** list | Select **GET** |
    | **URL** text box | Enter **/status/404** |

1. Back on the **Design** tab, in the list of operations, select **Modify Status Code**.

1. In the **Design** section, on the **Inbound processing** tile, select **+ Add policy**.

1. In the **Add inbound policy** section, select the **Rewrite URL** tile.

1. In the **Rewrite URL** section, perform the following actions:
       
    a.  In the **Backend** text box, enter **/status/200**.
    
    b.  Select **Save**.

1. Back on the **Design** tab, in the list of operations, select **Modify Status Code**, and then select the **Test** tab.
    
1. In the **Modify Status Code** section, select **Send**.

1. Review the results of the API request.

    > **Note**: Verify that the request returned the **HTTP/1.1 200 OK** response.

    ![](./media/15125(13).png)
   
### Review

In this exercise, you built a proxy tier between your App Service resource and any developers who wish to make queries against its API.

## You have successfully completed the lab 
