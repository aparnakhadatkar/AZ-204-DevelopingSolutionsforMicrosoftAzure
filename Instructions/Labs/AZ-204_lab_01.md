# Lab 01: Build a web application on Azure platform as a service offering

## Lab Scenario
In this lab, you will explore how to create a web application on Azure by using the PaaS model. After the web application is created, you will learn how to upload existing web application files by using the Apache Kudu zip deployment option. You will then view and test the newly deployed web application.

<em>View this video by right-clicking this **[video link](https://youtu.be/EiSEcU9qjfo)** and select 'Open link in a new tab / new window'.</em>

## Lab objectives
In this lab, you will perform:

+ Exercise 1: Build a backend API by using Azure Storage and the Web Apps feature of Azure App Service
+ Exercise 2: Build a front-end web application by using Azure Web Apps
    
## Estimated timing: 60 minutes

## Architecture diagram

![Architecture diagram depicting a user building a web application on Azure platform as a service offering.](./media/Lab01-Diagram1.png)

## Lab setup and pre-requisites

Before starting this lab, you must complete the **Prerequisites** of this lab.

To install the **C#** extension for this lab, follow the below steps in Visual Studio code:

1. Start Visual Studio Code from the desktop.

     ![Visual Studio Code Icon](./media/vscode.jpg)

2. Select the **Extensions** blade from the left panel.

3. Search with **C#** and select **Install** to install the extension.

    ![](./media/Csharp.png)

4. After installing C# extensions, close the Visual Studio code.

## Exercise 1: Build a backend API by using Azure Storage and the Web Apps feature of Azure App Service

In this exercise, you will create a web app in Azure and then deploy your ASP.NET web application to Web Apps by using the Azure CLI and Apache Kudu zip file deployment utility.

### Task 1: Open the Azure portal

1. If you are not logged in already, click on the **Azure portal** shortcut that is available on the desktop and log in with Azure credentials.

1. If not Sign-in, then on the **Sign into Microsoft Azure** tab you will see the login screen, in that enter the following **Email/Username** and then click on **Next**. 

   * Email/Username: <inject key="AzureAdUserEmail"></inject>
   
     ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/raw/main/media/M2-Ex1-portalsignin-1.png?raw=true)
    
1. Now enter the following **Password** and click on **Sign in**.

   * Password: <inject key="AzureAdUserPassword"></inject>

     ![](./media/M2-Ex1-portalsignin-(2).png)
    
1. If you see the pop-up **Stay Signed in?**, click No.

    ![](./media/staysignedinNO1.png)

1. On the **Welcome to Microsoft Azure** page, click on **Cancel**.

    ![](./media/15125(1).png)

### Task 2: Create a Storage account

1. In the Azure portal, use the **Search resources, services, and docs** text box to search for **Storage Accounts**, and then in the list of results, select **Storage Accounts**.

1. On the **Storage accounts** blade, select **+ Create**.

1. On the **Create a storage account** blade, on the **Basics** tab, perform the following actions, and then select **Review + create**:

    | Setting                         | Action                                                       |
    | ------------------------------- | ------------------------------------------------------------ |
    | **Subscription** drop-down list | Retain the default value.                                    |
    | **Resource group** section      | Select **ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/>** |
    | **Storage account name** text box | Enter  **imgstor<inject key="DeploymentID" enableCopy="false"/>**             |
    | **Region** drop-down list       | Select **(US) East US** |
    | **Primary service** | No changes |
    | **Performance** section | Select the **Standard** option |
    | **Redundancy** drop-down list | Select **Locally-redundant storage (LRS)** |

    The following screenshot displays the configured settings on the **Basics** tab of the **Create a storage account** blade.

    ![](./media/15125(2).png)

1. On the **Review + create** tab, review the options that you selected during the previous steps.

1. Select **Create** to create the storage account by using your specified configuration.

    > **Note**: Wait for the creation task to complete before you proceed with this lab.

1. On the **Overview** blade, select the **Go to resource** button to navigate to the blade of the newly created storage account.

1. On the **Storage account** blade, in the **Security + networking** section, select **Access keys**.

1. On the **Access keys** blade, review any one of the **Connection string**s (using **Show** button), and then record the value of either **Connection string** boxes in Notepad. The **Key**s are platform managed encryption keys and are **not** used for this lab.

    ![](./media/string1.png)

    > **Note**: It doesn't matter which connection string you choose. They are interchangeable.

1. Open Notepad, and then paste the copied connection string value to Notepad. You'll use this value later in this lab.

### Task 3: Upload a sample blob

1. From the **Storage Account** blade, under settings Select **Configuration**. Change **Allow Blob anonymous access** disabled to **Enabled** and click on **Save**.

1. From the **Storage Account** blade, in the **Data storage** section, select **Containers**.

1. In the **Containers** blade, select **+ Container**.

1. In the **New container** window, perform the following actions:

    | Setting                         | Action             |
    | ------------------------------- | ------------------------------------------------------------ |
    | **Name** text box | Enter **images**                                   |
    | **Public access level** list      | Select **Blob (anonymous read access for blobs only)**, and then select **Create** |

1. In the **Containers** blade, select the newly created **images** container.

1. In the **images** blade, select **Upload**.

1. In the **Upload blob** window, perform the following actions:

    | Setting                         | Action                                                       |
    | ------------------------------- | ------------------------------------------------------------ |
    | **Files** section | Click on **Browse for files**                                    |
    | **File Explorer** window      | Browse to **C:\\AllFiles\\AZ-204-DevelopingSolutionsforMicrosoftAzure-master\\Allfiles\\Labs\\01\\Starter\\Images**, select the               **grilledcheese.jpg** file, and then select **Open** |
    | **Overwrite if files already exist** check box | Ensure that the check box is selected, and then select **Upload**                                |

> **Note**: Wait for the blob to upload before you continue with this lab.

> **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:

   - Hit the Validate button for the corresponding task. If you receive a success message, you can proceed to the next task. 
   - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
   - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help.

<validation step="0b94ad9e-01db-4cf8-8a87-d21da4a19c2c" />
    
### Task 4: Create a web app

1. On the Azure portal's navigation pane, select **+ Create a resource**.

1. On the **Create a resource** blade, in the **Search services and marketplace** text box, enter **Web App**, and then select Enter.

1. On the **Marketplace** search results blade, select the **Web App** result.

1. On the **Web App** blade, select **Create**.

1. On the **Create Web App** blade, on the **Basics** tab, perform the following actions, and then select the **Monitor + secure** tab:

    | Setting | Action |
    | --- | --- |
    | **Subscription** drop-down list    | Retain the default value |
    | **Resource group** section         | Select **ManagedPlatform<inject key="DeploymentID" enableCopy="false"/>** |
    | **Name** text box                  | Enter **imgapi<inject key="DeploymentID" enableCopy="false"/>** |
    | **Secure unique default hostname** | **Disabled**                         |
    | **Publish** section                | Select **Code**  |
    | **Runtime stack** drop-down list   | Select **.NET 8 (LTS)** |
    | **Operating System** section       | Select **Windows**  |
    | **Region** drop-down list          | Select the **West US** region  |
    | **Windows Plan (East US)** section | Select **Create new**, enter the value **ManagedPlan** in the **Name** text box, and then select **OK** |
    | **Pricing plan** section | Select **Standard S1** |

    The following screenshot displays the configured settings on the **Create web app** blade.

    ![Create web app blade](./media/15125(3).png)

1. On the **Monitor + secure** tab, in the **Enable Application Insights** section, select **No**, and then select **Review + create**.

1. On the **Review + create** tab, review the options that you selected during the previous steps.

1. Select **Create** to create the web app by using your specified configuration.

    > **Note**: Wait for the web app to be created before you continue with this lab.

1. On the **Overview** blade, select the **Go to resource** button to navigate to the blade of the newly created web app.

### Task 5: Configure the web app

1. On the **App Service** blade, in the **Settings** section, select the **Environment variables** link.

1. In the **App settings** tab, select **+ Add**. Enter the following information in the **Add/Edit application setting** pop-up dialog:

     | Setting | Action |
     |--|--|
     | **Name** text box | Enter **StorageConnectionString** |
     | **Value** text box | Paste the storage connection string that you previously copied to Notepad |
     | **Deployment slot setting** check box | Retain the default value |

1. Select **Apply** to close the pop-up dialog and return to the **App settings** section.

1. At the bottom of the **App settings** section, select **Apply**.

    >**Note:** You may receive a warning that your app may restart when updating app settings. Select **Confirm**. Wait for your application settings to save before you continue with the lab.

1. To get the App Service's URL, go to the **Overview** link, copy the value from the **Default domain** section, and then paste it to Notepad. Prepend `https://` to the domain name in Notepad. You’ll use this value later in the lab.

    > **Note**: At this point, the web server at this URL will return a placeholder webpage. You haven't deployed any code to the Web App yet. You'll deploy code to the Web App later in this lab.

### Task 6: Deploy an `ASP.NET` web application to Web Apps

1. On the desktop, double-click the **Visual Studio Code** icon.

1. On the **File** menu, select **Open Folder**.

1. In the **File Explorer** window, browse to `C:\\AllFiles\\AZ-204-DevelopingSolutionsforMicrosoftAzure-master\\Allfiles\\Labs\\01\\Starter\\API` and then select **Select Folder**.

    > **Note**: Ignore any prompts to add required assets to build and debug and to run the restore command to address unresolved dependencies.

1. On the **Visual Studio Code** pop-up select **Yes, I trust the authors**.

1. On the **Explorer** pane of the **Visual Studio Code** window, expand the **Controllers** folder, and then select the **ImagesController.cs** file to open the file in the editor.

1. In the editor, in the **ImagesController** class on line 26, observe the **GetCloudBlobContainer** method and the code used to retrieve a container.

1. In the **ImagesController** class on line 36, observe the **Get** method and the code used to retrieve all blobs asynchronously from the **images** container.

1. In the **ImagesController** class on line 68, observe the **Post** method and the code used to persist an uploaded image to Storage.

1. On the taskbar, select the **Terminal -\> New Terminal**.

1. At the open terminal, enter the following command, and then select Enter to sign in to the Azure Command-Line Interface (CLI):

    ```
    az login
    ```

1. In the **Microsoft Edge** browser window, select **Work or School account**, enter the * Email address <inject key="AzureAdUserEmail"></inject> and * Password: <inject key="AzureAdUserPassword"></inject> for your Microsoft account, and then select **Sign in**.

1. Return to the currently open **Terminal** window. Wait for the sign-in process to finish.

1. If you see **Select a subscription and tenant (Type a number or Enter for no changes):**, simply press **Enter** to proceed without making any changes.

1. At the command prompt, enter the following command, and then select Enter to list all the apps in your **ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/>** resource group:

    ```
    az webapp list --resource-group ManagedPlatform-<inject key="Deployment ID" enableCopy="false"/>
    ```

1. Enter the following command, and then select Enter to find the apps that have the **imgapi\*** prefix:

    ```
    az webapp list --resource-group ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/> --query "[?starts_with(name, 'imgapi')]"
    ```

1. Enter the following command, and then select Enter to render only the name of the single app that has the **imgapi\*** prefix:

    ```
    az webapp list --resource-group ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/> --query "[?starts_with(name, 'imgapi')].{Name:name}" --output tsv
    ```

1. Enter the following command, and then select Enter to change the current directory to the `C:\\AllFiles\\AZ-204-DevelopingSolutionsforMicrosoftAzure-master\\Allfiles\\Labs\\01\\Starter\\API` directory that contains the lab files:

    ```
    cd C:\AllFiles\AZ-204-DevelopingSolutionsforMicrosoftAzure-master\Allfiles\Labs\01\Starter\API\
    ```

1. Enter the following command, and then select Enter to deploy the **api.zip** file to the web app that you created previously in this lab:

    ```
    az webapp deployment source config-zip --resource-group ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/> --src api.zip --name <name-of-your-api-app>
    ```

    > **Note**: Replace the *\<name-of-your-api-app\>* placeholder with the name of the web app that you created previously in this lab. You recently queried this app’s name in the previous steps.

    > **Note**: Wait for the deployment to complete before you continue with this lab.

1. On the Azure portal's **navigation** pane, select the **Resource Groups** link.

1. On the **Resource Groups** blade, select the **ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/>** resource group that you created previously in this lab.

1. On the **ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/>** blade, select the **imgapi<inject key="DeploymentID" enableCopy="false"/>** web app that you created previously in this lab.

1. From the **App Service** blade, select **Browse**.

    > **Note**: The **Browse** command will perform a GET request to the root of the website, which returns a JavaScript Object Notation (JSON) array. This array should contain the URL for your single uploaded image in your Storage account.

1. Return to your browser window that contains the Azure portal.

1. Close the currently running Visual Studio Code and Windows Terminal applications.

> **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:

   - Hit the Validate button for the corresponding task. If you receive a success message, you can proceed to the next task. 
   - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
   - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help.

<validation step="0b94ad9e-01db-4cf8-8a87-d21da4a19c2c" />

### Review
In this exercise, you created a web app in Azure and then deployed your `ASP.NET` web application to Web Apps by using the Azure CLI and Apache Kudu zip file deployment utility.

## Exercise 2: Build a front-end web application by using Azure Web Apps

In this exercise, you create an Azure web app and deploy an existing web application’s code to the resource in the cloud.

### Task 1: Create a web app

1. On the Azure portal's **navigation** pane, select **+ Create a resource**.

1. On the **Create a resource** blade, in the **Search services and marketplace** text box, enter **Web App**, and then select Enter.

1. On the **Marketplace** search results blade, select **Web App**.

1. On the **Web App** blade, select **Create**.

1. On the **Create Web App** blade, on the **Basics** tab, perform the following actions, and then select the **Monitor + secure** tab:

   | Setting                         | Action                                                       |
   | ------------------------------- | ------------------------------------------------------------ |
   | **Subscription** drop-down list | Retain the default value.                                    |
   | **Resource group** section      | Select **ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/>** |
   | **Name** text box | Enter **imgweb<inject key="DeploymentID" enableCopy="false"/>** |
   | **Secure unique default hostname** | **Disabled**                  |
   | **Publish** section | Select **Code** |
   | **Runtime stack** drop-down list | Select **.NET 8 (LTS)** |
   | **Operating System** section       | Select **Windows**                                        |
   | **Region** drop-down list          | Select the **West US** region                               |
   | **Windows Plan (East US)** section | Select **ManagedPlan (S1)** |

   The following screenshot displays the configured settings on the **Create web app** blade.

   ![](./media/15125(4).png)

1. On the **Monitor + secure** tab, in the **Enable Application Insights** section, select **No**, and then select **Review + create**.

1. From the **Review + create** tab, review the options that you selected during the previous steps.

1. Select **Create** to create the web app by using your specified configuration.

   > **Note**: Wait for the creation task to complete before you continue with this lab.

1. On the **Overview** blade, select the **Go to resource** button to navigate to the blade of the newly created web app.

### Task 2: Configure a web app

1. On the **App Service** blade, in the **Settings** section, select the **Environment variables** link.

1. In the **Environment variables** section, perform the following actions, select **Save**, and then select **Continue**:

    | Setting | Action |
    |--|--|
    | **App settings** tab | Select **+ Add** |
    | **Add/Edit application setting** pop-up dialog | In the **Name** text box, enter **ApiUrl** |
    | **Value** text box | Enter the web app URL that you copied previously in this lab. **Note**: Make sure you include the protocol **https://**, in the URL that you copy into the **Value** text box for this application setting |
    | **Deployment slot setting** check box | Retain the default value, and then select **OK** |
    | Click **Apply** and **Confirm** in the  top menu | This will save the configuration value you just entered |

   > **Note**: Wait for the application settings to save before you continue with this lab.

   > **Note**: Wait for the application settings to save before you continue with this lab, for web app **URL** use the previous one which you copied in exercise 1 task 5.

### Task 3: Deploy an `ASP.NET` web application to Web Apps

1. On the desktop, double-click the **Visual Studio Code** icon.

1. On the **File** menu, select **Open Folder**.

1. In the **File Explorer** window, browse to `C:\\AllFiles\\AZ-204-DevelopingSolutionsforMicrosoftAzure-master\\Allfiles\\Labs\\01\\Starter\\Web`, and then select **Select Folder**.

    > **Note**: Ignore any prompts to add required assets to build and debug and to run the restore command to address unresolved dependencies.

1. On the **Explorer** pane of the **Visual Studio Code** window, expand the **Pages** folder, and then select the **Index.cshtml.cs** file to open the file in the editor.

1. In the editor, in the **IndexModel** class on line 30, observe the **OnGetAsync** method and the code used to retrieve the list of images from the API.

1. In the **IndexModel** class on line 41, observe the **OnPostAsync** method and the code used to stream an uploaded image to the backend API.

1. On the taskbar, select the **Terminal -\> New Terminal**.

1. At the open terminal, enter the following command, and then select Enter to sign in to the Azure CLI:

    ```
    az login
    ```

1. In the **Microsoft Edge** browser window, select **Work or School account**, enter the * Email address: <inject key="AzureAdUserEmail"></inject> and * Password: <inject key="AzureAdUserPassword"></inject> for your Microsoft account, and then select **Sign in**.

1. Return to the currently open **Terminal** window. Wait for the sign-in process to finish.

1. If you see **Select a subscription and tenant (Type a number or Enter for no changes):**, simply press **Enter** to proceed without making any changes.

1. Enter the following command, and then select Enter to list all the apps in your **ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/>** resource group:

    ```
    az webapp list --resource-group ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/>
    ```
    
1. Enter the following command, and then select Enter to find the apps that have the **imgweb\*** prefix:

    ```
    az webapp list --resource-group ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/> --query "[?starts_with(name, 'imgweb')]"
    ```

1. Enter the following command, and then select Enter to render only the name of the single app that has the **imgweb\*** prefix:

    ```
    az webapp list --resource-group ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/> --query "[?starts_with(name, 'imgweb')].{Name:name}" --output tsv
    ```

1. Enter the following command, and then select Enter to change the current directory to the `C:\\AllFiles\\AZ-204-DevelopingSolutionsforMicrosoftAzure-master\\Allfiles\\Labs\\01\\Starter\\\Web` directory that contains the lab files:

    ```
    cd C:\AllFiles\AZ-204-DevelopingSolutionsforMicrosoftAzure-master\Allfiles\Labs\\01\Starter\Web\
    ```

1. Enter the following command, and then select Enter to deploy the **web.zip** file to the web app that you created previously in this lab:

    ```
    az webapp deployment source config-zip --resource-group ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/> --src web.zip --name <name-of-your-web-app>
    ```

    > **Note**: Replace the *\<name-of-your-web-app\>* placeholder with the name of the web app that you created previously in this lab. You recently queried this app’s name in the previous steps.

    > **Note**: Wait for the deployment to complete before you continue with this lab.

1. On the Azure portal's **navigation** pane, select **Resource groups**.

1. On the **Resource groups** blade, select the **ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/>** 

1. On the **ManagedPlatform-<inject key="DeploymentID" enableCopy="false"/>** blade, select the **imgweb<inject key="DeploymentID" enableCopy="false"/>** web app that you created previously in this lab.

1. On the **App Service** blade, select **Browse**.

1. Observe the list of images in the gallery. The gallery should list a single image that was uploaded to Storage previously in the lab.

1. In the **Contoso Photo Gallery** webpage, in the **Upload a new image** section, perform the following actions:

    a.  Select **Browse**.

    b.  In the **File Explorer** window, browse to `C:\\AllFiles\\AZ-204-DevelopingSolutionsforMicrosoftAzure-master\\Allfiles\\Labs\\01\\Starter\\Images`, select the **bahnmi.jpg** file, and then select **Open**.

    c.  Select **Upload**.

1. Observe that the list of gallery images has been updated with your new image.

   ![Output_image](./media/AZ-204-1.png)

    > **Note**: In some rare cases, you might need to refresh your browser window to retrieve the new image.

1. Return to the browser window that contains the Azure portal.

1. Close the currently running Visual Studio Code and Windows Terminal applications.

> **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:

   - Hit the Validate button for the corresponding task. If you receive a success message, you can proceed to the next task. 
   - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
   - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help.

<validation step="a08a994e-c230-4b9e-9a20-04a0643cecc8" />

### Review
In this exercise, you created an Azure web app and deployed an existing web application’s code to the resource in the cloud.

## You have successfully completed the lab
